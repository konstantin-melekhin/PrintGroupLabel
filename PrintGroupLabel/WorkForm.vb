Imports Library3

Public Class WorkForm
    Dim ExitToSet As Boolean
    Dim SQL As String
    Private Sub Form_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        CB_SN_or_Box.Checked = True
        Controllabel.Text = ""
        'Устанавливаем дефолты при загоузке формы 
        'Настройка COM порта
        PrintSerialPort.PortName = "com3"
        PrintSerialPort.BaudRate = 115200
        'Требуется печать или нет
        Try
            PrintSerialPort.Open()
            PrintSerialPort.Close()
        Catch ex As Exception
            PrintLabel(Controllabel, "Проверьте подключение ком порта!", 12, 142, Color.Red) ' если не настроен ком порт для печати
            CB_SN_or_Box.Enabled = False
            TB_ScanSN.Enabled = False
        End Try
        'Переносим константы из формы настроек в рабочую форму. Данные получаем из таблицы M_Lots
        'Запуск программы
        '___________________________________________________________
        GetLotList_ContractStation(DG_Lot)
        GetTimeSec()

    End Sub
    'запуск таймера
    Private Sub CurrentTimeTimer_Tick(sender As Object, e As EventArgs) Handles CurrentTimeTimer.Tick
        GetTimeSec()
    End Sub
    Dim CurentTimeSec As Integer
    Private Sub GetTimeSec()
        CurrentTimeTimer.Start()
        CurrrentTimeLabel.Text = TimeString
        CurentTimeSec = CurrrentTimeLabel.Text.Substring(0, 2) * 3600 + CurrrentTimeLabel.Text.Substring(3, 2) * 60 + CurrrentTimeLabel.Text.Substring(6, 2)
    End Sub

    Dim SearchSNList As New ArrayList
    Dim SNArray As New ArrayList
    Private Sub TB_ScanSN_KeyDown(sender As Object, e As KeyEventArgs) Handles TB_ScanSN.KeyDown
        If e.KeyCode = Keys.Enter Then
            SearchSNList = SerchSN(TB_ScanSN.Text)
            If SearchSNList.Count <> 0 Then
                SerchBoxForPrint(SearchSNList(1), SearchSNList(3))
                SNArray = GetSNFromGrid()
                If SNArray.Count = 13 Then
                    PrintGroupLabel(SNArray)
                Else
                    PrintLabel(Controllabel, "Корбка еще не закрыта!", 12, 142, Color.Red)
                End If
                TB_ScanSN.Clear()
            Else
                TB_ScanSN.Clear()
                PrintLabel(Controllabel, "Номер не найден в базе!", Color.Red)
                Exit Sub
            End If
        End If
    End Sub

    Private Sub NumBox_KeyDown(sender As Object, e As KeyEventArgs) Handles NumBox.KeyDown
        If e.KeyCode = Keys.Enter And Lot <> 0 Then
            System.Threading.Thread.Sleep(1000)
            SerchBoxForPrint(Lot, NumBox.Value)
            SNArray = GetSNFromGrid()
            If SNArray.Count = 13 Then
                PrintGroupLabel(SNArray)
            Else
                PrintLabel(Controllabel, "Корбка еще не закрыта!", 12, 142, Color.Red)
            End If
            NumBox.Value += 1
        End If
    End Sub

    Private Function SerchSN(Sn As String)
        SQL = "use fas
                SELECT  l.Content,p.[LOTID],Lit.LiterName ,[BoxNum]
                FROM [FAS].[dbo].[Ct_PackingTable] as P
                left join [SMDCOMPONETS].[dbo].[LazerBase] as L On l.IDLaser = PCBID
                left join dbo.Ct_FASSN_reg as F On F.ID =P.SNID
                left join dbo.FAS_Liter as Lit On Lit.ID = P.LiterID
                where l.Content = '" & Sn & "'"
        Return SelectListString(SQL) 'IB365MC001409
    End Function

    Private Sub SerchBoxForPrint(LotID As Integer, BoxNum As Integer) 'LitName As String,
        SQL = "use fas
                SELECT  [UnitNum] as '№',l.Content AS 'Серийный номер платы',Lit.LiterName as 'Литера' ,[BoxNum]as 'Номер коробки' 
                FROM [FAS].[dbo].[Ct_PackingTable] as P
                left join [SMDCOMPONETS].[dbo].[LazerBase] as L On l.IDLaser = PCBID
                left join dbo.Ct_FASSN_reg as F On F.ID =P.SNID
                left join dbo.FAS_Liter as Lit On Lit.ID = P.LiterID
                where p.lotid =" & LotID & " and BoxNum = " & BoxNum & "
                order by UnitNum desc" 'and LiterName= '" & LitName & "'
        LoadGridFromDB(DG_SelectedBox, SQL)
    End Sub

    Private Function GetSNFromGrid()
        Dim SNArrayTemp As New ArrayList
        If DG_SelectedBox.Rows.Count > 0 Then
            For i = 0 To DG_SelectedBox.Rows.Count - 1
                SNArrayTemp.Add(Mid(DG_SelectedBox.Item(1, i).Value, 1, 7) & ">5" & Mid(DG_SelectedBox.Item(1, i).Value, 8))
            Next
            SNArrayTemp.Add(DG_SelectedBox.Item(3, 0).Value)
        Else
            PrintLabel(Controllabel, "Корбка еще не закрыта!", 12, 142, Color.Red)
        End If
        Return SNArrayTemp
    End Function

    Private Sub PrintGroupLabel(sn As ArrayList)
        Dim Content As String = "
^XA~TA000~JSN^LT0^MNW^MTT^PON^PMN^LH0,0^JMA^MD10^JUS^LRN^CI0^XZ
~DG000.GRF,06144,064,
,:::::::::::::::::::::::::::::::::::::::J01FF0I01FF,::J01FF80H03FF,:::J01F7C0H07DF,:J01F7C0H07DF0H01FF80O03FC0J01F80X0HFP01FF80gO0HFC0O01FF8,J01F3E0H0F9F0H0IFE01FJFC00FHFI07C7FE003E003F81F0H07C003FFC01F003E00FHFE0H01FHFE0J07FIFE00FJFC007FHFH0KFE00FHFE,J01F3E0H0F9F001FIF81FJFC03FHFC007CFHFH03E003F81F0H07C00FHFE01F007E01FIF8007FHFE0J07FIFE00FJFC00FIFC0FJFE01FIF80,J01F3E0H0F9F003FIF81FJFC07FHFE007DFHF803E007F81F0H07C01FIF01F00FE03FIF801FIFE0J07FIFE00FJFC01FIFC0FJFE03FIF80,J01F1F001F1F007FIFC1FJFC0FJFH07DFHFC03E007F81F0H07C03FIF81F01FE07FIFC01FIFE0J07FIFE00FJFC03FIFE0FJFE07FIFC0,J01F1F001F1F00FF01FC1FJFC1FE07F807FE0FE03E00FF81F0H07C07F83FC1F01FE0FF01FC03FIFE0J07FIFE00FJFC07F80FE0FJFE0FF01FC0,J01F1F001F1F00FC007E0H0F8001F801F807F807E03E00FF81F0H07C07E00FC1F03E00FC007E07F003E0J07C003E00F8007C07E003F0H07C0H0FC007E0,J01F1F803F1F01F8003E0H0F8003F0H07C07F003F03E01FF81F0H07C0FC007E1F03E01F8003E07E003E0J07C003E00F8007C0FC001F0H07C001F8003E0,J01F0F803E1F01F8003E0H0F8003E0H07C07F001F03E01FF81F0H07C0F8007E1F03C01F8003E07C003E0J07C003E00F8007C0FC001F0H07C001F8003E0,J01F0F803E1F0070H03E0H0F8003C0H03C07E001F03E03EF81F0H07C0F800381F07C0070H03E07C003E0J07C003E00F8007C038001F0H07C0H070H03E0,J01F0F803E1F0K03E0H0F8007C0H03E07E001F83E03EF81F0H07C1F80I01F0780K03E07C003E0J07C003E00F8007C0J01F0H07C0L03E0,J01F07C07C1F0K0FE0H0F8007FJFE07C0H0F83E07CF81F0H07C1F0J01F0F80K0FE07C003E0J07C003E00F8007C0J07F0H07C0L0FE0,J01F07C07C1F0I01FFE0H0F8007FJFE07C0H0F83E07CF81FJFC1F0J01F0F0J01FFE07E003E0J07C003E00F8007C0I0IFI07C0J01FFE0,J01F07C07C1F0H07FHFE0H0F8007FJFE07C0H0F83E0F8F81FJFC1F0J01F1F0I07FHFE03F803E0J07C003E00F8007C003FIFI07C0I07FHFE0,J01F03E0F81F003FIFE0H0F8007FJFE07C0H0F83E0F8F81FJFC1F0J01FFE0H03FIFE03FIFE0J07C003E00F8007C01FJFI07C0H03FIFE0,J01F03E0F81F007FIFE0H0F8007FJFE07C0H0F83E1F0F81FJFC1F0J01FF80H07FIFE01FIFE0J07C003E00F8007C03FJFI07C0H07FIFE0,J01F03E0F81F00FIF3E0H0F8007C0K07C0H0F83E3F0F81FJFC1F0J01FFE0H0JF3E00FIFE0J07C003E00F8007C07FHF9F0H07C0H0JF3E0,J01F03F1F81F01FFC03E0H0F8007C0K07C0H0F83E3E0F81F0H07C1F0J01F3F001FFC03E007FHFE0J07C003E00F8007C0FFE01F0H07C001FFC03E0,J01F01F1F01F01F8003E0H0F8007C0K07C0H0F83E7E0F81F0H07C1F0J01F1F801F8003E0H0IFE0J07C003E00F8007C0FC001F0H07C001F8003E0,J01F01F1F01F03F0H03E0H0F8007E0K07C001F83E7C0F81F0H07C1F8001C1F0FC03F0H03E001F83E0J07C003E00F8007C1F8001F0H07C003F0H03E0,J01F01F1F01F03E0H07E0H0F8003E0H03007E001F03EF80F81F0H07C0F8001F1F07C03E0H07E003E03E0J07C003E00F8007C1F0H03F0H07C003E0H07E0,J01F00FBE01F03E0H07E0H0F8003F0H07E07E001F03EF80F81F0H07C0F8003F1F07E03E0H07E007E03E0J07C003E00F8007C1F0H03F0H07C003E0H07E0,J01F00FBE01F03E0H0FE0H0F8003F0H0FC07F003F03FF00F81F0H07C0FC003E1F03E03E0H0FE00FC03E0J07C003E00F8007C1F0H07F0H07C003E0H0FE0,J01F00FBE01F03F001FE0H0F8001FC01FC07F807E03FF00F81F0H07C07E007E1F03F03F001FE00F803E0J07C003E00F8007C1F800FF0H07C003F001FE0,J01F007FC01F03FC0FFE0H0F8001FE03F807FC1FE03FE00F81F0H07C07F81FC1F01F83FC0FFE01F803E0J07C003E01F8007C1FE07FF0H07C003FC0FFE0,J01F007FC01F01FJFE0H0F80H0KF807FIFC03FE00F81F0H07C03FIFC1F00F81FJFE03F003E0J07C003E1FF8007C0FKFI07C001FJFE0,J01F007FC01F01FIFBE0H0F80H07FIFH07DFHF803FC00F81F0H07C01FIF81F00FC1FIFBE03E003E0J07C003E1FF8007C0FIFDF0H07C001FIFBE0,J01F007FC01F00FIF3E0H0F80H03FHFE007CFHFH03FC00F81F0H07C00FIF01F007C0FIF3E07E003E0J07C003E1FF0H07C07FHF9F0H07C0H0JF3E0,J01F003F801F003FFE3F0H0F80I0IF8007C7FE003F800F81F0H07C003FFC01F007E03FFE3F0FC003E0J07C003E1FE0H07C01FHF1F8007C0H03FFE3F0,J01F003F801F0H0HF01F0H0F80I03FE0H07C3F0H03F800F81F0H07C0H0HFH01F003F00FF01F0FC003E0J07C003E1FC0H07C007F80F8007C0I0HF01F0,gW07C0,::::::::::,:::::~DG001.GRF,04352,068,
,::::::::::::::::::kW07,J03C0H03C0iQ0381C0gM0IF,J03C0H03C0iQ03C3C0gL07FFE,J03C0H03C0iQ01FF80gK01FHFC,J03C0H03C0iR0HF80gK03E0,J03C0H03C0iR07E0gL0380,J03C0H03C0kG07,:J03C0H03C007F0P07F0I03F0P0FC0Y0FE0N07F0V07F0I03F0H01FC0071F80,J03C0H03C01FFC01F0H07C01FFC01E7FC0I03FFC79FF03C00787FHFC0FIF803FF803FFC001FFC01E00F0I03C0F01FFC01E7FC007FF00E3FF00781E1E00F,J03C0H03C03FFE01F800FC03FFE01EFFE0I03FFC7BFF81E00787FHFC0FIF807FFC03FHFH03FFE01E01F0I03C1F03FFE01EFFE00FHF80EFHF80783E1E01F,J03C0H03C07C1F01F800FC07C1F01FE1F0I03FFC7F87C1E00F07FHFC0FIF80F83E03FHF807C1F01E01F0I03C1F07C1F01FE1F01F07C0FF0FC0783E1E01F,J03C0H03C0780F01F800FC0780F81F80F0I03C007E03C1F00F07803C0F00780F01E03C07C0780F01E03F0I03C380780F01F80F01E03C0FC03C078701E03F,J03FJFC0F00781FC01FC0F00781F80780H03C007E01E0F00F07803C0F00781E00F03C03C0F00781E03F0I03C380F00781F80783C01E0FC01E078701E03F,J03FJFC0F00781EC01BC0F00381F00780H03C007C01E0F01E07803C0F00781E00F03C03C0F00781E07F0I03C780F00781F00783C01E0F801E078F01E07F,J03FJFC1E003C1EC01BC1E003C1F003C0H03C007C00F0F81E07803C0F00783C00783C03C1E003C1E06F0I03C701E003C1F003C7800F0F800F078E01E06F,J03FJFC1E003C1EE03BC1E003C1E003C0H03C007800F0781E07803C0F00783C00783C03C1E003C1E0EF0I03C701E003C1E003C7800F0F0H0F078E01E0EF,J03C0H03C1E003C1E6033C1FIFC1E003C0H03C007800F0783C07803C0F00783C00783C0781E003C1E1CF0I03CE01E003C1E003C7800F0F0H0F079C01E1CF,J03C0H03C1E003C1E6033C1FIFC1E003C0H03C007800F07C3C07803C0F00783C00783FHF01E003C1E1CF0I03CE01E003C1E003C7800F0F0H0F079C01E1CF,J03C0H03C1E003C1E7073C1FIFC1E003C0H03C007800F03C3C07803C0F00783C00783FHF01E003C1E38F0I03FC01E003C1E003C7800F0F0H0F07F801E38F,J03C0H03C1E003C1E3063C1E0I01E003C0H03C007800F03E7807803C0F00783C00783FHF81E003C1E38F0I03FC01E003C1E003C7800F0F0H0F07F801E38F,J03C0H03C1E003C1E30E3C1E0I01E003C0H03C007800F01E7807803C0F00783C00783C07C1E003C1E70F0I03DE01E003C1E003C7800F0F0H0F07BC01E70F,J03C0H03C1E003C1E38E3C1E0I01E003C0H03C007800F01E7807803C0F00783C00783C03E1E003C1E70F0I03CF01E003C1E003C7800F0F0H0F079E01E70F,J03C0H03C1E003C1E18C3C1F00101E00380H03C007800E01F7807803C0F00783C00783C01E1E003C1EE0F0I03C781E003C1E00387800F07001E078F01EE0F,J03C0H03C0F00781E19C3C0F003C1F00780H03C007C01E00F7007803C0F00781E00F03C01E0F00781EE0F0I03C780F00781F00783C01E07801E078F01EE0F,J03C0H03C0F00781E1DC3C0F00381F00780H03C007C01E00FF007803C0F00781E00F03C01E0F00781FC0F0I03C3C0F00781F00783C01E07803E078781FC0F,J03C0H03C0780F01E0D83C0780781F80F0I03C007E03C00FF007803C0F00780F01E03C01E0780F01F80F0I03C3E0780F01F80F01E03C03C03C0787C1F80F,J03C0H03C07C1F01E0F83C07E1F01FC1F0I03C007F07C007E007803C0F00780F83E03C07C07C1F01F80F0I03C1E07C1F01FC1F01F07C01F0F80783C1F80F,J03C0H03C03FFE01E0F83C03FFE01FHFE0I03C007FHF8007E007803C0F007807FFC03FHFC03FFE01F00F0I03C1F03FFE01FHFE00FHF800FHF80783E1F00F,J03C0H03C01FFC01E0703C01FFC01EFF80I03C007BFE0H03E007803C0F007803FF803FHF801FFC01F00F0I03C0F01FFC01EFF8007FF0H07FF00781E1F00F,J03C0H03C007F001E0703C007F001E3E0J03C0078F80H03C007803C0F007800FE003FFE0H07F001E00F0I03C0F807F001E3E0H01FC0H01FC00781F1E00F,gP01E0P0780J03C0hN01E0,gP01E0P0780J07C0hN01E0,gP01E0P0780J0780hN01E0,gP01E0P0780J0F80hN01E0,gP01E0P0780I01F0hO01E0,gP01E0P0780H01FE0hO01E0,gP01E0P0780I0FE0hO01E0,gP01E0P0780I0F80hO01E0,,:::::^XA
^MMT
^PW1063
^LL1169
^LS0
^FT128,160^XG000.GRF,1,1^FS
^FT128,224^XG001.GRF,1,1^FS
^BY3,3,106^FT50,381^BCN,,Y,N
^FD>:" & sn(0) & "^FS
^BY3,3,106^FT50,522^BCN,,Y,N
^FD>:" & sn(1) & "^FS
^BY3,3,106^FT50,662^BCN,,Y,N
^FD>:" & sn(2) & "^FS
^BY3,3,106^FT50,803^BCN,,Y,N
^FD>:" & sn(3) & "^FS
^BY3,3,106^FT50,943^BCN,,Y,N
^FD>:" & sn(4) & "^FS
^BY3,3,106^FT50,1084^BCN,,Y,N
^FD>:" & sn(5) & "^FS
^BY3,3,106^FT556,381^BCN,,Y,N
^FD>:" & sn(6) & "^FS
^BY3,3,106^FT556,522^BCN,,Y,N
^FD>:" & sn(7) & "^FS
^BY3,3,106^FT556,662^BCN,,Y,N
^FD>:" & sn(8) & "^FS
^BY3,3,106^FT556,803^BCN,,Y,N
^FD>:" & sn(9) & "^FS
^BY3,3,106^FT556,943^BCN,,Y,N
^FD>:" & sn(10) & "^FS
^BY3,3,106^FT556,1084^BCN,,Y,N
^FD>:" & sn(11) & "^FS
^FT666,149^A0N,54,52^FH\^FDAQB365MC^FS
^FT666,217^A0N,54,52^FH\^FD" & sn(12) & "^FS
^PQ1,0,1,Y^XZ
^XA^ID000.GRF^FS^XZ
^XA^ID001.GRF^FS^XZ
"

        PrintSerialPort.Open()
        PrintSerialPort.Write(Content) 'ответ в COM порт
        PrintSerialPort.Close()
    End Sub

    Private Sub CB_SN_or_Box_CheckedChanged(sender As Object, e As EventArgs) Handles CB_SN_or_Box.CheckedChanged
        If CB_SN_or_Box.Checked = True Then
            NumBox.Visible = False
            TB_ScanSN.Visible = True
            CB_SN_or_Box.Text = "Отсканируйте серийный номер"
            GB_Lot.Visible = False
            DG_SelectedBox.Visible = True
            Controllabel.Text = ""
            TB_ScanSN.Focus()
        Else
            NumBox.Location = New Point(12, 43)
            TB_ScanSN.Visible = False
            CB_SN_or_Box.Text = "Введите номер коробки"
            GB_Lot.Visible = True
            GB_Lot.Location = New Point(17, 236)
            DG_SelectedBox.Visible = False
            PrintLabel(Controllabel, "Выберите ЛОТ для печати!", 12, 142, Color.Red)

        End If
    End Sub
    'Опредеяем номер выбранной строки в таблице лотов
    Public selRowNum, LOTID As Integer
    Dim Lot As Integer
    Private Sub DG_LOTListPresent_CellClick(sender As Object, e As DataGridViewCellEventArgs) Handles DG_Lot.CellClick
        selRowNum = DG_Lot.CurrentCell.RowIndex
        If MsgBox("ЛОТ выбран?", vbYesNo) = vbYes Then
            GB_Lot.Visible = False
            DG_SelectedBox.Visible = True
            NumBox.Visible = True
            Controllabel.Text = ""
            NumBox.Focus()
        End If
        Lot = DG_Lot.Item(3, selRowNum).Value
    End Sub

End Class